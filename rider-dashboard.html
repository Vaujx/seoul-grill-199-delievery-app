<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rider Dashboard - Seoul Grill 199</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Add some basic styles for debugging messages */
        .debug-panel {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .debug-message {
            margin: 5px 0;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        .debug-error {
            color: #dc3545;
            font-weight: bold;
        }
        .debug-success {
            color: #28a745;
        }
        .debug-info {
            color: #17a2b8;
        }
        
        /* Enhanced Profile UI Styles */
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .profile-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }
        
        .profile-banner {
            background: linear-gradient(135deg, #ff7e5f, #feb47b);
            height: 120px;
            position: relative;
        }
        
        .profile-avatar-container {
            position: absolute;
            bottom: -40px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            border-radius: 50%;
            padding: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .profile-avatar {
            font-size: 64px;
            color: #555;
            background-color: #f5f5f5;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .profile-info {
            padding: 60px 20px 20px;
            text-align: center;
        }
        
        .profile-name {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .profile-username {
            color: #777;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .profile-status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background-color: #e6f7e6;
            color: #28a745;
            margin-bottom: 20px;
        }
        
        .profile-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        
        .profile-stat-card {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px 20px;
            min-width: 150px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }
        
        .profile-stat-card:hover {
            transform: translateY(-5px);
        }
        
        .profile-stat-icon {
            font-size: 24px;
            color: #ff7e5f;
            margin-bottom: 10px;
        }
        
        .profile-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            margin: 5px 0;
        }
        
        .profile-stat-label {
            font-size: 14px;
            color: #777;
        }
        
        .profile-actions {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }
        
        .change-password-form {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .change-password-form h3 {
            margin-top: 0;
            color: #333;
            font-size: 18px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        
        .message.success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="logo-container">
                <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/image-RWjdnXkskPQdAzWyp6DajpomlhNsH7.png" alt="Seoul Grill 199 Logo" class="logo-small">
                <h1>Seoul Grill 199</h1>
            </div>
            <div class="user-info">
                <span id="rider-name">Rider</span>
                <button id="logout-btn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
        </header>
        
        <nav class="dashboard-nav">
            <button class="nav-btn active" data-tab="active">Active Deliveries</button>
            <button class="nav-btn" data-tab="history">Delivery History</button>
            <button class="nav-btn" data-tab="profile">My Profile</button>
            <button class="nav-btn" data-tab="debug">Debug</button>
        </nav>
        
        <main class="dashboard-content">
            <!-- Active Deliveries Tab -->
            <section id="active-tab" class="tab-content active">
                <div class="section-header">
                    <h2>Active Deliveries</h2>
                    <button id="refresh-active" class="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                
                <div id="active-deliveries" class="deliveries-container">
                    <!-- Active deliveries will be populated here -->
                    <p class="no-data">Loading active deliveries...</p>
                </div>
            </section>
            
            <!-- Delivery History Tab -->
            <section id="history-tab" class="tab-content">
                <div class="section-header">
                    <h2>Delivery History</h2>
                    <button id="refresh-history" class="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                
                <div id="delivery-history" class="deliveries-container">
                    <!-- Delivery history will be populated here -->
                    <p class="no-data">Loading delivery history...</p>
                </div>
            </section>
            
            <!-- Profile Tab - Enhanced UI -->
            <section id="profile-tab" class="tab-content">
                <div class="section-header">
                    <h2>My Profile</h2>
                </div>
                
                <div class="profile-container">
                    <div class="profile-card">
                        <div class="profile-banner"></div>
                        <div class="profile-avatar-container">
                            <div class="profile-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                        </div>
                        <div class="profile-info">
                            <h3 class="profile-name" id="profile-name">Loading profile...</h3>
                            <p class="profile-username" id="profile-username"></p>
                            <div class="profile-status-badge" id="rider-status">Active</div>
                            
                            <div class="profile-stats">
                                <div class="profile-stat-card">
                                    <div class="profile-stat-icon">
                                        <i class="fas fa-truck"></i>
                                    </div>
                                    <div class="profile-stat-value" id="total-deliveries">0</div>
                                    <div class="profile-stat-label">Total Deliveries</div>
                                </div>
                                
                                <div class="profile-stat-card">
                                    <div class="profile-stat-icon">
                                        <i class="fas fa-phone"></i>
                                    </div>
                                    <div class="profile-stat-value" id="contact-number">-</div>
                                    <div class="profile-stat-label">Contact Number</div>
                                </div>
                            </div>
                            
                            <div class="profile-actions">
                                <button id="change-password-btn" class="primary-btn">
                                    <i class="fas fa-key"></i> Change Password
                                </button>
                            </div>
                            
                            <!-- Change Password Form -->
                            <div id="change-password-form" class="change-password-form" style="display: none;">
                                <h3>Change Password</h3>
                                <div class="input-group">
                                    <label for="current-password">Current Password</label>
                                    <input type="password" id="current-password" placeholder="Enter current password">
                                </div>
                                <div class="input-group">
                                    <label for="new-password">New Password</label>
                                    <input type="password" id="new-password" placeholder="Enter new password">
                                </div>
                                <div class="input-group">
                                    <label for="confirm-password">Confirm New Password</label>
                                    <input type="password" id="confirm-password" placeholder="Confirm new password">
                                </div>
                                <div class="form-actions">
                                    <button id="save-password-btn" class="primary-btn">Save Changes</button>
                                    <button id="cancel-password-btn" class="secondary-btn">Cancel</button>
                                </div>
                                <p id="password-message" class="message"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Debug Tab -->
            <section id="debug-tab" class="tab-content">
                <div class="section-header">
                    <h2>Debug Information</h2>
                    <button id="clear-debug" class="refresh-btn"><i class="fas fa-trash"></i> Clear</button>
                </div>
                
                <div class="debug-container">
                    <div class="debug-actions">
                        <button id="test-fetch-btn" class="primary-btn">Test Fetch Orders</button>
                        <button id="fix-data-structure-btn" class="primary-btn">Fix Data Structure</button>
                    </div>
                    <div id="debug-panel" class="debug-panel" style="display: block;">
                        <div class="debug-message debug-info">Debug information will appear here...</div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <!-- Delivery Details Modal -->
    <div id="delivery-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Delivery Details</h2>
            <div id="delivery-details">
                <!-- Delivery details will be populated here -->
            </div>
            <div class="modal-actions">
                <button id="mark-delivered-btn" class="primary-btn">Mark as Delivered</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        const ACCOUNTS_BIN = '67f8d1f78a456b7966871dae';
        const ORDERS_BIN = '67efd7ca8a456b7966826626';
        const X_ACCESS_KEY = '$2a$10$W73./QvpSBFFjn2P/D2tB.TOq17FvGpJ5oHqu4DWHc0rBw5GteM1K';
        let ordersData = [];
        let currentUser = null;
        
        // Debug functions
        function logDebug(message, type = 'info') {
            const debugPanel = document.getElementById('debug-panel');
            const messageElement = document.createElement('div');
            messageElement.className = `debug-message debug-${type}`;
            
            // Format objects for better display
            if (typeof message === 'object') {
                try {
                    message = JSON.stringify(message, null, 2);
                } catch (e) {
                    message = message.toString();
                }
            }
            
            messageElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugPanel.appendChild(messageElement);
            debugPanel.scrollTop = debugPanel.scrollHeight;
            
            // Also log to console
            console[type === 'error' ? 'error' : type === 'success' ? 'info' : 'log'](message);
        }
        
        // Clear debug panel
        document.getElementById('clear-debug').addEventListener('click', () => {
            document.getElementById('debug-panel').innerHTML = '';
        });
        
        // Test fetch button
        document.getElementById('test-fetch-btn').addEventListener('click', () => {
            testFetchOrders();
        });
        
        // Fix data structure button
        document.getElementById('fix-data-structure-btn').addEventListener('click', async () => {
            try {
                logDebug('Attempting to fix data structure...', 'info');
                
                // Fetch current data
                const response = await fetch(`https://api.jsonbin.io/v3/b/${ORDERS_BIN}`, {
                    method: 'GET',
                    headers: {
                        'X-Access-Key': X_ACCESS_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch orders: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data || !data.record) {
                    throw new Error('Invalid data format received from JSONBin');
                }
                
                // Convert object with numeric keys to array
                const fixedData = [];
                const record = data.record;
                
                // Process numeric keys
                for (let key in record) {
                    if (!isNaN(parseInt(key)) && record[key]) {
                        fixedData.push(record[key]);
                    }
                }
                
                // Process orders array if it exists
                if (record.orders && Array.isArray(record.orders)) {
                    fixedData.push(...record.orders);
                }
                
                logDebug(`Converted ${fixedData.length} orders to array format`, 'success');
                
                // Update JSONBin with fixed structure
                const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${ORDERS_BIN}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': X_ACCESS_KEY
                    },
                    body: JSON.stringify(fixedData)
                });
                
                if (!updateResponse.ok) {
                    throw new Error(`Failed to update orders: ${updateResponse.status} ${updateResponse.statusText}`);
                }
                
                logDebug('Successfully updated JSONBin with fixed data structure', 'success');
                
                // Refresh orders
                fetchOrders();
            } catch (error) {
                logDebug(`Error fixing data structure: ${error.message}`, 'error');
            }
        });
        
        // Test fetch orders function
        async function testFetchOrders() {
            logDebug('Testing fetch orders...', 'info');
            
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${ORDERS_BIN}`, {
                    method: 'GET',
                    headers: {
                        'X-Access-Key': X_ACCESS_KEY
                    }
                });
                
                logDebug(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch orders: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                logDebug('Response data received:', 'success');
                logDebug(data);
                
                if (!data || !data.record) {
                    throw new Error('Invalid data format received from JSONBin');
                }
                
                // Check data structure
                const record = data.record;
                if (Array.isArray(record)) {
                    logDebug(`Data is already in array format with ${record.length} orders`, 'success');
                } else {
                    logDebug('Data is in object format with numeric keys', 'info');
                    
                    // Count orders in object format
                    let count = 0;
                    for (let key in record) {
                        if (!isNaN(parseInt(key))) count++;
                    }
                    
                    // Check for orders array
                    if (record.orders && Array.isArray(record.orders)) {
                        count += record.orders.length;
                        logDebug(`Found additional ${record.orders.length} orders in 'orders' array`, 'info');
                    }
                    
                    logDebug(`Total orders found: ${count}`, 'info');
                    logDebug('Consider using the "Fix Data Structure" button to convert to array format', 'info');
                }
            } catch (error) {
                logDebug(`Error in test fetch: ${error.message}`, 'error');
            }
        }
        
        // Check authentication
        window.addEventListener('DOMContentLoaded', () => {
            const user = JSON.parse(sessionStorage.getItem('user'));
            if (!user || user.role !== 'rider') {
                window.location.href = 'index.html';
                return;
            }
            
            currentUser = user;
            document.getElementById('rider-name').textContent = user.name;
            
            // Load initial data
            fetchOrders();
            loadProfile();
            
            // Set up tab navigation
            setupTabs();
            
            // Log initialization
            logDebug('Rider dashboard initialized', 'info');
        });
        
        // Logout functionality
        document.getElementById('logout-btn').addEventListener('click', () => {
            sessionStorage.removeItem('user');
            window.location.href = 'index.html';
        });
        
        // Tab navigation
        function setupTabs() {
            const navBtns = document.querySelectorAll('.nav-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            navBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.getAttribute('data-tab');
                    
                    // Update active button
                    navBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // Show selected tab
                    tabContents.forEach(tab => {
                        if (tab.id === `${tabId}-tab`) {
                            tab.classList.add('active');
                        } else {
                            tab.classList.remove('active');
                        }
                    });
                });
            });
        }
        
        // Fetch orders from JSONBin
        async function fetchOrders() {
            try {
                logDebug('Fetching orders from JSONBin...', 'info');
                
                const response = await fetch(`https://api.jsonbin.io/v3/b/${ORDERS_BIN}`, {
                    method: 'GET',
                    headers: {
                        'X-Access-Key': X_ACCESS_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch orders: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                logDebug('Orders data received:', 'success');
                
                if (!data || !data.record) {
                    throw new Error('Invalid data format received from JSONBin');
                }
                
                // Process the data based on its structure
                const record = data.record;
                
                // Check if record is already an array
                if (Array.isArray(record)) {
                    ordersData = record;
                    logDebug(`Processed ${ordersData.length} orders from array`, 'success');
                } else {
                    // Convert object with numeric keys to array
                    ordersData = [];
                    
                    // Process numeric keys
                    for (let key in record) {
                        if (!isNaN(parseInt(key)) && record[key]) {
                            ordersData.push(record[key]);
                        }
                    }
                    
                    // Process orders array if it exists
                    if (record.orders && Array.isArray(record.orders)) {
                        ordersData.push(...record.orders);
                    }
                    
                    logDebug(`Processed ${ordersData.length} orders from object structure`, 'success');
                }
                
                // Display orders
                displayActiveDeliveries();
                displayDeliveryHistory();
            } catch (error) {
                logDebug(`Error fetching orders: ${error.message}`, 'error');
                document.getElementById('active-deliveries').innerHTML = `<p class="no-data">Error loading deliveries: ${error.message}</p>`;
                document.getElementById('delivery-history').innerHTML = `<p class="no-data">Error loading delivery history: ${error.message}</p>`;
            }
        }
        
        // Display active deliveries
        function displayActiveDeliveries() {
            const activeDeliveriesContainer = document.getElementById('active-deliveries');
            activeDeliveriesContainer.innerHTML = '';
            
            // Filter assigned orders for current rider
            const activeDeliveries = ordersData.filter(order => 
                order && order.assignedTo === currentUser.username && order.status === 'Assigned'
            );
            
            if (activeDeliveries.length === 0) {
                activeDeliveriesContainer.innerHTML = '<p class="no-data">No active deliveries found</p>';
                return;
            }
            
            activeDeliveries.forEach(order => {
                const deliveryCard = document.createElement('div');
                deliveryCard.className = 'delivery-card';
                
                // Safely get order properties with fallbacks
                const id = order.id || 'Unknown';
                const customerName = order.customer?.name || 'Unknown';
                const customerPhone = order.customer?.phone || 'Unknown';
                const address = order.customer?.address || 'Unknown';
                const total = order.total || 0;
                
                deliveryCard.innerHTML = `
                    <div class="delivery-header">
                        <h3>Order #${id}</h3>
                        <span class="delivery-date">${order.date || 'Unknown date'}</span>
                    </div>
                    <div class="delivery-details">
                        <p><strong>Customer:</strong> ${customerName}</p>
                        <p><strong>Phone:</strong> ${customerPhone}</p>
                        <p><strong>Address:</strong> ${address}</p>
                        <p><strong>Total:</strong> ₱${typeof total === 'number' ? total.toFixed(2) : '0.00'}</p>
                    </div>
                    <div class="delivery-actions">
                        <button class="view-delivery-btn" data-id="${id}">View Details</button>
                        <button class="mark-delivered-btn" data-id="${id}">Mark as Delivered</button>
                    </div>
                `;
                
                activeDeliveriesContainer.appendChild(deliveryCard);
            });
            
            // Add event listeners to buttons
            document.querySelectorAll('.view-delivery-btn').forEach(btn => {
                btn.addEventListener('click', () => viewDeliveryDetails(btn.getAttribute('data-id')));
            });
            
            document.querySelectorAll('.mark-delivered-btn').forEach(btn => {
                btn.addEventListener('click', () => markAsDelivered(btn.getAttribute('data-id')));
            });
        }
        
        // Display delivery history
        function displayDeliveryHistory() {
            const deliveryHistoryContainer = document.getElementById('delivery-history');
            deliveryHistoryContainer.innerHTML = '';
            
            // Filter delivered orders for current rider
            const deliveryHistory = ordersData.filter(order => 
                order && order.assignedTo === currentUser.username && order.status === 'Delivered'
            );
            
            if (deliveryHistory.length === 0) {
                deliveryHistoryContainer.innerHTML = '<p class="no-data">No delivery history found</p>';
                return;
            }
            
            // Sort by delivered date (newest first)
            deliveryHistory.sort((a, b) => {
                const dateA = a.deliveredAt ? new Date(a.deliveredAt) : new Date(0);
                const dateB = b.deliveredAt ? new Date(b.deliveredAt) : new Date(0);
                return dateB - dateA;
            });
            
            deliveryHistory.forEach(order => {
                const historyCard = document.createElement('div');
                historyCard.className = 'delivery-card history-card';
                
                // Safely get order properties with fallbacks
                const id = order.id || 'Unknown';
                const customerName = order.customer?.name || 'Unknown';
                const address = order.customer?.address || 'Unknown';
                const total = order.total || 0;
                
                // Format delivered date
                let deliveredDate = 'Unknown';
                if (order.deliveredAt) {
                    const date = new Date(order.deliveredAt);
                    deliveredDate = date.toLocaleString();
                }
                
                historyCard.innerHTML = `
                    <div class="delivery-header">
                        <h3>Order #${id}</h3>
                        <span class="delivery-date">${deliveredDate}</span>
                    </div>
                    <div class="delivery-details">
                        <p><strong>Customer:</strong> ${customerName}</p>
                        <p><strong>Address:</strong> ${address}</p>
                        <p><strong>Total:</strong> ₱${typeof total === 'number' ? total.toFixed(2) : '0.00'}</p>
                    </div>
                    <div class="delivery-actions">
                        <button class="view-history-btn" data-id="${id}">View Details</button>
                    </div>
                `;
                
                deliveryHistoryContainer.appendChild(historyCard);
            });
            
            // Add event listeners to view history buttons
            document.querySelectorAll('.view-history-btn').forEach(btn => {
                btn.addEventListener('click', () => viewDeliveryDetails(btn.getAttribute('data-id'), true));
            });
        }
        
        // View delivery details
        function viewDeliveryDetails(orderId, isHistory = false) {
            const order = ordersData.find(o => o && o.id === orderId);
            if (!order) return;
            
            const modal = document.getElementById('delivery-modal');
            const deliveryDetails = document.getElementById('delivery-details');
            const markDeliveredBtn = document.getElementById('mark-delivered-btn');
            
            // Hide or show mark as delivered button based on whether it's history
            markDeliveredBtn.style.display = isHistory ? 'none' : 'block';
            
            // Build items list
            let itemsList = '';
            if (Array.isArray(order.items)) {
                itemsList = '<ul class="order-items-list">';
                order.items.forEach(item => {
                    const name = item?.name || 'Unknown Item';
                    const price = item?.price || 0;
                    itemsList += `<li>${name} - ₱${typeof price === 'number' ? price.toFixed(2) : '0.00'}</li>`;
                });
                itemsList += '</ul>';
            } else {
                itemsList = '<p>No items found</p>';
            }
            
            // Format delivered date if available
            let deliveredInfo = '';
            if (order.deliveredAt) {
                const date = new Date(order.deliveredAt);
                deliveredInfo = `
                    <div class="delivery-info">
                        <p><strong>Delivered At:</strong> ${date.toLocaleString()}</p>
                    </div>
                `;
            }
            
            deliveryDetails.innerHTML = `
                <div class="order-header">
                    <h3>Order #${order.id}</h3>
                    <span class="order-date">${order.date || 'Unknown date'}</span>
                </div>
                
                <div class="customer-info">
                    <h4>Customer Information</h4>
                    <p><strong>Name:</strong> ${order.customer?.name || 'Unknown'}</p>
                    <p><strong>Phone:</strong> ${order.customer?.phone || 'Unknown'}</p>
                    <p><strong>Address:</strong> ${order.customer?.address || 'Unknown'}</p>
                </div>
                
                <div class="order-items">
                    <h4>Order Items</h4>
                    ${itemsList}
                </div>
                
                <div class="order-summary">
                    <p><strong>Subtotal:</strong> ₱${typeof order.subtotal === 'number' ? order.subtotal.toFixed(2) : (typeof order.total === 'number' ? order.total.toFixed(2) : '0.00')}</p>
                    ${order.deliveryFee ? `<p><strong>Delivery Fee:</strong> ₱${order.deliveryFee.toFixed(2)}</p>` : ''}
                    ${order.shippingFee ? `<p><strong>Shipping Fee:</strong> ₱${order.shippingFee.toFixed(2)}</p>` : ''}
                    <p class="order-total"><strong>Total:</strong> ₱${typeof order.total === 'number' ? order.total.toFixed(2) : '0.00'}</p>
                </div>
                
                ${deliveredInfo}
            `;
            
            // Set up mark as delivered button
            markDeliveredBtn.onclick = () => markAsDelivered(orderId);
            
            // Show modal
            modal.style.display = 'block';
            
            // Close modal when clicking X
            document.querySelector('.close-modal').onclick = () => {
                modal.style.display = 'none';
            };
            
            // Close modal when clicking outside
            window.onclick = (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }
        
        // Mark order as delivered
        async function markAsDelivered(orderId) {
            try {
                // Find order in ordersData
                const orderIndex = ordersData.findIndex(o => o && o.id === orderId);
                if (orderIndex === -1) throw new Error('Order not found');
                
                // Update order status
                ordersData[orderIndex].status = 'Delivered';
                ordersData[orderIndex].delivered = true;
                ordersData[orderIndex].deliveredAt = new Date().toISOString();
                
                // Update JSONBin
                const response = await fetch(`https://api.jsonbin.io/v3/b/${ORDERS_BIN}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': X_ACCESS_KEY
                    },
                    body: JSON.stringify(ordersData)
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update order');
                }
                
                // Update rider's delivery count
                await updateDeliveryCount();
                
                // Close modal if open
                document.getElementById('delivery-modal').style.display = 'none';
                
                // Refresh displays
                displayActiveDeliveries();
                displayDeliveryHistory();
                
                alert('Order marked as delivered successfully!');
            } catch (error) {
                console.error('Error marking order as delivered:', error);
                alert('Failed to mark order as delivered. Please try again.');
            }
        }
        
        // Update rider's delivery count
        async function updateDeliveryCount() {
            try {
                // Fetch accounts data
                const response = await fetch(`https://api.jsonbin.io/v3/b/${ACCOUNTS_BIN}`, {
                    method: 'GET',
                    headers: {
                        'X-Access-Key': X_ACCESS_KEY
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch accounts data');
                }
                
                const data = await response.json();
                
                if (!data || !data.record || !data.record.rider) {
                    throw new Error('Invalid accounts data format');
                }
                
                const accountsData = data.record;
                
                // Find current rider in accounts data
                const riderIndex = accountsData.rider.findIndex(r => r && r.username === currentUser.username);
                if (riderIndex === -1) throw new Error('Rider not found in accounts data');
                
                // Increment delivery count
                if (!accountsData.rider[riderIndex].deliveries) {
                    accountsData.rider[riderIndex].deliveries = 0;
                }
                accountsData.rider[riderIndex].deliveries++;
                
                // Update current user in session storage
                currentUser.deliveries = accountsData.rider[riderIndex].deliveries;
                sessionStorage.setItem('user', JSON.stringify(currentUser));
                
                // Update accounts data in JSONBin
                const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${ACCOUNTS_BIN}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Access-Key': X_ACCESS_KEY
                    },
                    body: JSON.stringify(accountsData)
                });
                
                if (!updateResponse.ok) {
                    throw new Error('Failed to update accounts data');
                }
                
                // Update profile display
                loadProfile();
            } catch (error) {
                console.error('Error updating delivery count:', error);
            }
        }
        
        // Load rider profile
        function loadProfile() {
            try {
                // Display current user information
                document.getElementById('profile-name').textContent = currentUser.name || 'Unknown';
                document.getElementById('profile-username').textContent = currentUser.username || '';
                
                // Format phone number for display
                const phoneNumber = currentUser.phone || 'Not available';
                document.getElementById('contact-number').textContent = phoneNumber;
                
                // Set status badge
                const statusElement = document.getElementById('rider-status');
                statusElement.textContent = currentUser.status || 'Active';
                
                // Update total deliveries
                document.getElementById('total-deliveries').textContent = currentUser.deliveries || 0;
                
                // Set up change password form
                setupChangePasswordForm();
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }
        
        // Set up change password form
        function setupChangePasswordForm() {
            const changePasswordBtn = document.getElementById('change-password-btn');
            const changePasswordForm = document.getElementById('change-password-form');
            const savePasswordBtn = document.getElementById('save-password-btn');
            const cancelPasswordBtn = document.getElementById('cancel-password-btn');
            
            // Show form when clicking change password button
            changePasswordBtn.addEventListener('click', () => {
                changePasswordForm.style.display = 'block';
                changePasswordBtn.style.display = 'none';
            });
            
            // Hide form when clicking cancel button
            cancelPasswordBtn.addEventListener('click', () => {
                changePasswordForm.style.display = 'none';
                changePasswordBtn.style.display = 'block';
                
                // Clear form
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
                document.getElementById('password-message').textContent = '';
            });
            
            // Save password when clicking save button
            savePasswordBtn.addEventListener('click', async () => {
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const messageElement = document.getElementById('password-message');
                
                // Validate inputs
                if (!currentPassword || !newPassword || !confirmPassword) {
                    messageElement.textContent = 'Please fill in all fields';
                    messageElement.className = 'message error';
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    messageElement.textContent = 'New passwords do not match';
                    messageElement.className = 'message error';
                    return;
                }
                
                if (currentPassword !== currentUser.password) {
                    messageElement.textContent = 'Current password is incorrect';
                    messageElement.className = 'message error';
                    return;
                }
                
                try {
                    // Fetch accounts data
                    const response = await fetch(`https://api.jsonbin.io/v3/b/${ACCOUNTS_BIN}`, {
                        method: 'GET',
                        headers: {
                            'X-Access-Key': X_ACCESS_KEY
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch accounts data');
                    }
                    
                    const data = await response.json();
                    
                    if (!data || !data.record || !data.record.rider) {
                        throw new Error('Invalid accounts data format');
                    }
                    
                    const accountsData = data.record;
                    
                    // Find current rider in accounts data
                    const riderIndex = accountsData.rider.findIndex(r => r && r.username === currentUser.username);
                    if (riderIndex === -1) throw new Error('Rider not found in accounts data');
                    
                    // Update password
                    accountsData.rider[riderIndex].password = newPassword;
                    
                    // Update accounts data in JSONBin
                    const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${ACCOUNTS_BIN}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Access-Key': X_ACCESS_KEY
                        },
                        body: JSON.stringify(accountsData)
                    });
                    
                    if (!updateResponse.ok) {
                        throw new Error('Failed to update password');
                    }
                    
                    // Update current user in session storage
                    currentUser.password = newPassword;
                    sessionStorage.setItem('user', JSON.stringify(currentUser));
                    
                    // Show success message
                    messageElement.textContent = 'Password updated successfully';
                    messageElement.className = 'message success';
                    
                    // Clear form
                    document.getElementById('current-password').value = '';
                    document.getElementById('new-password').value = '';
                    document.getElementById('confirm-password').value = '';
                    
                    // Hide form after a delay
                    setTimeout(() => {
                        changePasswordForm.style.display = 'none';
                        changePasswordBtn.style.display = 'block';
                        messageElement.textContent = '';
                    }, 2000);
                } catch (error) {
                    console.error('Error updating password:', error);
                    messageElement.textContent = 'Failed to update password. Please try again.';
                    messageElement.className = 'message error';
                }
            });
        }
        
        // Refresh buttons
        document.getElementById('refresh-active').addEventListener('click', fetchOrders);
        document.getElementById('refresh-history').addEventListener('click', fetchOrders);
    </script>
</body>
</html>