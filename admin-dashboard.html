<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - Seoul Grill 199</title>
<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    /* Add some basic styles for debugging messages */
    .debug-panel {
        background-color: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }
    .debug-message {
        margin: 5px 0;
        padding: 5px;
        border-bottom: 1px solid #eee;
    }
    .debug-error {
        color: #dc3545;
        font-weight: bold;
    }
    .debug-success {
        color: #28a745;
    }
    .debug-info {
        color: #17a2b8;
    }
    
    /* Order Details Modal Styles */
    .order-details-modal .modal-content {
        max-width: 600px;
    }
    
    .order-details-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    
    .order-details-header h3 {
        margin: 0;
        font-size: 1.5rem;
        color: #333;
    }
    
    .order-status {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }
    
    .order-status.processing {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .order-status.assigned {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    
    .order-status.delivered {
        background-color: #d4edda;
        color: #155724;
    }
    
    .order-section {
        margin-bottom: 20px;
    }
    
    .order-section h4 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #555;
        font-size: 1.1rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 5px;
    }
    
    .customer-info {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .customer-info p {
        margin: 5px 0;
    }
    
    .order-items-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .order-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #f5f5f5;
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .order-summary {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
    }
    
    .order-summary p {
        display: flex;
        justify-content: space-between;
        margin: 5px 0;
    }
    
    .order-total {
        font-weight: bold;
        font-size: 1.1rem;
        border-top: 1px solid #ddd;
        padding-top: 10px;
        margin-top: 10px;
    }
    
    .assignment-info {
        background-color: #e9ecef;
        padding: 15px;
        border-radius: 5px;
        margin-top: 15px;
    }
    
    /* Loading indicator */
    .loading-indicator {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .loading-spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>
</head>
<body>
<div class="dashboard-container">
    <header class="dashboard-header">
        <div class="logo-container">
            <img src="https://hebbkx1anhila5yf.public.blob.vercel-storage.com/image-RWjdnXkskPQdAzWyp6DajpomlhNsH7.png" alt="Seoul Grill 199 Logo" class="logo-small">
            <h1>Seoul Grill 199</h1>
        </div>
        <div class="user-info">
            <span id="admin-name">Admin</span>
            <button id="logout-btn" class="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </header>
    
    <nav class="dashboard-nav">
        <button class="nav-btn active" data-tab="orders">Orders</button>
        <button class="nav-btn" data-tab="riders">Delivery Personnel</button>
        <button class="nav-btn" data-tab="assign">Assign Orders</button>
        <button class="nav-btn" data-tab="add-rider">Add Driver</button>
        <button class="nav-btn" data-tab="debug">Debug</button>
    </nav>
    
    <main class="dashboard-content">
        <!-- Orders Tab -->
        <section id="orders-tab" class="tab-content active">
            <div class="section-header">
                <h2>Orders Management</h2>
                <div class="filter-controls">
                    <select id="status-filter">
                        <option value="all">All Orders</option>
                        <option value="Processing">Processing</option>
                        <option value="Assigned">Assigned</option>
                        <option value="Delivered">Delivered</option>
                    </select>
                    <button id="refresh-orders" class="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
            </div>
            
            <div class="orders-container">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Address</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="orders-list">
                        <!-- Orders will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Order Assignment Modal -->
            <div id="assignment-modal" class="modal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2>Assign Order</h2>
                    <div class="order-details" id="modal-order-details">
                        <!-- Order details will be populated here -->
                    </div>
                    <div class="rider-selection">
                        <label for="rider-select">Select Delivery Personnel:</label>
                        <select id="rider-select">
                            <!-- Riders will be populated here -->
                        </select>
                    </div>
                    <button id="assign-btn" class="primary-btn">Assign Order</button>
                </div>
            </div>
            
            <!-- Order Details Modal -->
            <div id="order-details-modal" class="modal order-details-modal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2>Order Details</h2>
                    <div id="order-details-content">
                        <!-- Order details will be populated here -->
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Riders Tab -->
        <section id="riders-tab" class="tab-content">
            <div class="section-header">
                <h2>Delivery Personnel</h2>
                <button id="refresh-riders" class="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
            
            <div class="riders-container">
                <table class="riders-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Username</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Total Deliveries</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="riders-list">
                        <!-- Riders will be populated here -->
                    </tbody>
                </table>
            </div>
        </section>
        
        <!-- Assign Orders Tab -->
        <section id="assign-tab" class="tab-content">
            <div class="section-header">
                <h2>Assign Orders to Drivers</h2>
                <button id="refresh-assign" class="refresh-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
            </div>
            
            <div class="assign-container">
                <div class="assign-grid">
                    <div class="assign-column">
                        <h3>Step 1: Select Driver</h3>
                        <div class="input-group">
                            <select id="driver-select" class="full-width">
                                <option value="">Select a driver</option>
                                <!-- Drivers will be populated here -->
                            </select>
                        </div>
                        <div id="driver-info" class="driver-info-card">
                            <p>Select a driver to view their information</p>
                        </div>
                    </div>
                    
                    <div class="assign-column">
                        <h3>Step 2: Select Orders</h3>
                        <div class="input-group">
                            <input type="text" id="order-search" placeholder="Search orders by ID or customer name" class="full-width">
                        </div>
                        <div class="pending-orders-container">
                            <table class="orders-table">
                                <thead>
                                    <tr>
                                        <th>Select</th>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Address</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="pending-orders-list">
                                    <!-- Pending orders will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="assign-actions">
                    <button id="assign-orders-btn" class="primary-btn" disabled>
                        <i class="fas fa-truck"></i> Assign Selected Orders
                    </button>
                </div>
                
                <div class="assigned-orders-section">
                    <h3>Current Driver Assignments</h3>
                    <div class="driver-assignments-container">
                        <div id="driver-assignments" class="driver-assignments">
                            <!-- Driver assignments will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Add Rider Tab -->
        <section id="add-rider-tab" class="tab-content">
            <div class="section-header">
                <h2>Add New Delivery Personnel</h2>
            </div>
            
            <div class="add-rider-form">
                <div class="input-group">
                    <label for="rider-name">Full Name</label>
                    <input type="text" id="rider-name" placeholder="Enter full name">
                </div>
                <div class="input-group">
                    <label for="rider-username">Username</label>
                    <input type="text" id="rider-username" placeholder="Enter username">
                </div>
                <div class="input-group">
                    <label for="rider-password">Password</label>
                    <input type="password" id="rider-password" placeholder="Enter password">
                </div>
                <div class="input-group">
                    <label for="rider-phone">Phone Number</label>
                    <input type="text" id="rider-phone" placeholder="Enter phone number">
                </div>
                <button id="add-rider-btn" class="primary-btn">Add Delivery Personnel</button>
                <p id="add-rider-message" class="message"></p>
            </div>
        </section>
        
        <!-- Debug Tab -->
        <section id="debug-tab" class="tab-content">
            <div class="section-header">
                <h2>Debug Information</h2>
                <button id="clear-debug" class="refresh-btn"><i class="fas fa-trash"></i> Clear</button>
            </div>
            
            <div class="debug-container">
                <div class="debug-actions">
                    <button id="test-fetch-btn" class="primary-btn">Test Fetch Orders</button>
                    <button id="test-fetch-riders-btn" class="primary-btn">Test Fetch Riders</button>
                    <button id="fix-data-structure-btn" class="primary-btn">Fix Data Structure</button>
                </div>
                <div id="debug-panel" class="debug-panel" style="display: block;">
                    <div class="debug-message debug-info">Debug information will appear here...</div>
                </div>
            </div>
        </section>
    </main>
</div>

<script>
    // Global variables
    const ACCOUNTS_BIN = '67f8d1f78a456b7966871dae';
    const ORDERS_BIN = '67efd7ca8a456b7966826626';
    const X_ACCESS_KEY = '$2a$10$W73./QvpSBFFjn2P/D2tB.TOq17FvGpJ5oHqu4DWHc0rBw5GteM1K';
    let ordersData = [];
    let accountsData = {};
    let selectedDriver = null;
    let selectedOrders = new Set();
    
    // Debug functions
    function logDebug(message, type = 'info') {
        const debugPanel = document.getElementById('debug-panel');
        const messageElement = document.createElement('div');
        messageElement.className = `debug-message debug-${type}`;
        
        // Format objects for better display
        if (typeof message === 'object') {
            try {
                message = JSON.stringify(message, null, 2);
            } catch (e) {
                message = message.toString();
            }
        }
        
        messageElement.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        debugPanel.appendChild(messageElement);
        debugPanel.scrollTop = debugPanel.scrollHeight;
        
        // Also log to console
        console[type === 'error' ? 'error' : type === 'success' ? 'info' : 'log'](message);
    }
    
    // Clear debug panel
    document.getElementById('clear-debug').addEventListener('click', () => {
        document.getElementById('debug-panel').innerHTML = '';
    });
    
    // Test fetch buttons
    document.getElementById('test-fetch-btn').addEventListener('click', () => {
        testFetchOrders();
    });
    
    document.getElementById('test-fetch-riders-btn').addEventListener('click', () => {
        testFetchRiders();
    });
    
    // Fix data structure button
    document.getElementById('fix-data-structure-btn').addEventListener('click', async () => {
        try {
            logDebug('Attempting to fix data structure...', 'info');
            
            // Fetch current data
            const response = await fetch(`https://api.jsonbin.io/v3/b/${ORDERS_BIN}`, {
                method: 'GET',
                headers: {
                    'X-Access-Key': X_ACCESS_KEY
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch orders: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data || !data.record) {
                throw new Error('Invalid data format received from JSONBin');
            }
            
            // Convert object with numeric keys to array
            const fixedData = [];
            const record = data.record;
            
            // Process numeric keys
            for (let key in record) {
                if (!isNaN(parseInt(key)) && record[key]) {
                    fixedData.push(record[key]);
                }
            }
            
            // Process orders array if it exists
            if (record.orders && Array.isArray(record.orders)) {
                fixedData.push(...record.orders);
            }
            
            logDebug(`Converted ${fixedData.length} orders to array format`, 'success');
            
            // Update JSONBin with fixed structure
            const updateResponse = await fetch(`https://api.jsonbin.io/v3/b/${ORDERS_BIN}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Access-Key': X_ACCESS_KEY
                },
                body: JSON.stringify(fixedData)
            });
            
            if (!updateResponse.ok) {
                throw new Error(`Failed to update orders: ${updateResponse.status} ${updateResponse.statusText}`);
            }
            
            logDebug('Successfully updated JSONBin with fixed data structure', 'success');
            
            // Refresh orders
            fetchOrders();
        } catch (error) {
            logDebug(`Error fixing data structure: ${error.message}`, 'error');
        }
    });
    
    // Test fetch orders function
    async function testFetchOrders() {
        logDebug('Testing fetch orders...', 'info');
        
        try {
            // First, try with X-Access-Key
            logDebug('Attempting to fetch with X-Access-Key...', 'info');
            
            const response = await fetch(`https://api.jsonbin.io/v3/b/${ORDERS_BIN}`, {
                method: 'GET',
                headers: {
                    'X-Access-Key': X_ACCESS_KEY
                }
            });
            
            logDebug(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
            
            if (!response.ok) {
                throw new Error(`Failed to fetch orders: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            logDebug('Response data received:', 'success');
            logDebug(data);
            
            if (!data || !data.record) {
                throw new Error('Invalid data format received from JSONBin');
            }
            
            // Check data structure
            const record = data.record;
            if (Array.isArray(record)) {
                logDebug(`Data is already in array format with ${record.length} orders`, 'success');
            } else {
                logDebug('Data is in object format with numeric keys', 'info');
                
                // Count orders in object format
                let count = 0;
                for (let key in record) {
                    if (!isNaN(parseInt(key))) count++;
                }
                
                // Check for orders array
                if (record.orders && Array.isArray(record.orders)) {
                    count += record.orders.length;
                    logDebug(`Found additional ${record.orders.length} orders in 'orders' array`, 'info');
                }
                
                logDebug(`Total orders found: ${count}`, 'info');
                logDebug('Consider using the "Fix Data Structure" button to convert to array format', 'info');
            }
        } catch (error) {
            logDebug(`Error in test fetch: ${error.message}`, 'error');
        }
    }
    
    // Test fetch riders function
    async function testFetchRiders() {
        logDebug('Testing fetch riders...', 'info');
        
        try {
            // First, try with X-Access-Key
            logDebug('Attempting to fetch riders with X-Access-Key...', 'info');
            
            const response = await fetch(`https://api.jsonbin.io/v3/b/${ACCOUNTS_BIN}`, {
                method: 'GET',
                headers: {
                    'X-Access-Key': X_ACCESS_KEY
                }
            });
            
            logDebug(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
            
            if (!response.ok) {
                throw new Error(`Failed to fetch riders: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            logDebug('Response data received:', 'success');
            logDebug(data);
            
            if (!data || !data.record) {
                throw new Error('Invalid data format received from JSONBin');
            }
            
            logDebug('Successfully fetched riders data', 'success');
        } catch (error) {
            logDebug(`Error in test fetch riders: ${error.message}`, 'error');
        }
    }
    
    // Check authentication
    window.addEventListener('DOMContentLoaded', () => {
        const user = JSON.parse(sessionStorage.getItem('user'));
        if (!user || user.role !== 'admin') {
            window.location.href = 'index.html';
            return;
        }
        
        document.getElementById('admin-name').textContent = user.name;
        
        // Load initial data
        fetchOrders();
        fetchRiders();
        
        // Set up tab navigation
        setupTabs();
        
        // Set up order search functionality
        document.getElementById('order-search').addEventListener('input', filterPendingOrders);
        
        // Set up driver select change event
        document.getElementById('driver-select').addEventListener('change', handleDriverSelect);
        
        // Set up assign orders button
        document.getElementById('assign-orders-btn').addEventListener('click', assignSelectedOrders);
        
        // Log initialization
        logDebug('Admin dashboard initialized', 'info');
    });
    
    // Logout functionality
    document.getElementById('logout-btn').addEventListener('click', () => {
        sessionStorage.removeItem('user');
        window.location.href = 'index.html';
    });
    
    // Tab navigation
    function setupTabs() {
        const navBtns = document.querySelectorAll('.nav-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        
        navBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const tabId = btn.getAttribute('data-tab');
                
                // Update active button
                navBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Show selected tab
                tabContents.forEach(tab => {
                    if (tab.id === `${tabId}-tab`) {
                        tab.classList.add('active');
                        
                        // Refresh data when switching to assign tab
                        if (tabId === 'assign') {
                            populateDriverSelect();
                            displayPendingOrders();
                            displayDriverAssignments();
                        }
                    } else {
                        tab.classList.remove('active');
                    }
                });
            });
        });
    }
    
    // Fetch orders from JSONBin
    async function fetchOrders() {
        try {
            logDebug('Fetching orders from JSONBin...', 'info');
            const ordersList = document.getElementById('orders-list');
            ordersList.innerHTML = '<tr><td colspan="6" class="no-data">Loading orders...</td></tr>';
            
            const response = await fetch(`https://api.jsonbin.io/v3/b/${ORDERS_BIN}`, {
                method: 'GET',
                headers: {
                    'X-Access-Key': X_ACCESS_KEY
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch orders: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            logDebug('Orders data received:', 'success');
            
            if (!data || !data.record) {
                throw new Error('Invalid data format received from JSONBin');
            }
            
            // Process the data based on its structure
            const record = data.record;
            
            // Check if record is already an array
            if (Array.isArray(record)) {
                ordersData = record;
                logDebug(`Processed ${ordersData.length} orders from array`, 'success');
            } else {
                // Convert object with numeric keys to array
                ordersData = [];
                
                // Process numeric keys
                for (let key in record) {
                    if (!isNaN(parseInt(key)) && record[key]) {
                        ordersData.push(record[key]);
                    }
                }
                
                // Process orders array if it exists
                if (record.orders && Array.isArray(record.orders)) {
                    ordersData.push(...record.orders);
                }
                
                logDebug(`Processed ${ordersData.length} orders from object structure`, 'success');
            }
            
            // Apply current filter
            const statusFilter = document.getElementById('status-filter').value;
            displayOrders(statusFilter);
            
            // Update pending orders in assign tab if it's active
            if (document.getElementById('assign-tab').classList.contains('active')) {
                displayPendingOrders();
                displayDriverAssignments();
            }
        } catch (error) {
            logDebug(`Error fetching orders: ${error.message}`, 'error');
            const ordersList = document.getElementById('orders-list');
            ordersList.innerHTML = `<tr><td colspan="6" class="no-data">Error loading orders: ${error.message}</td></tr>`;
            alert('Failed to load orders. Please check the Debug tab for details.');
        }
    }
    
    // Display orders based on filter
    function displayOrders(filter = 'all') {
        const ordersList = document.getElementById('orders-list');
        ordersList.innerHTML = '';
        
        if (!ordersData || ordersData.length === 0) {
            ordersList.innerHTML = `<tr><td colspan="6" class="no-data">No orders found</td></tr>`;
            return;
        }
        
        let filteredOrders = ordersData;
        if (filter !== 'all') {
            filteredOrders = ordersData.filter(order => order.status === filter);
        }
        
        if (filteredOrders.length === 0) {
            ordersList.innerHTML = `<tr><td colspan="6" class="no-data">No ${filter.toLowerCase()} orders found</td></tr>`;
            return;
        }
        
        filteredOrders.forEach(order => {
            const row = document.createElement('tr');
            
            // Safely get order properties with fallbacks
            const id = order.id || 'Unknown';
            const customerName = order.customer?.name || 'Unknown';
            const customerPhone = order.customer?.phone || 'Unknown';
            const address = order.customer?.address || 'Unknown';
            const total = order.total || 0;
            const status = order.status || 'Unknown';
            const statusClass = (status && typeof status === 'string') ? 
                status.toLowerCase().replace(/\s+/g, '-') : 'unknown';
            
            row.innerHTML = `
                <td>${id}</td>
                <td>${customerName}<br>${customerPhone}</td>
                <td>${address}</td>
                <td>₱${typeof total === 'number' ? total.toFixed(2) : '0.00'}</td>
                <td><span class="status-badge ${statusClass}">${status}</span></td>
                <td>
                    <button class="view-btn" data-id="${id}"><i class="fas fa-eye"></i> View</button>
                    ${status === 'Processing' ? 
                        `<button class="assign-btn" data-id="${id}"><i class="fas fa-user-plus"></i> Assign</button>` : ''}
                </td>
            `;
            ordersList.appendChild(row);
        });
        
        // Add event listeners to buttons
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', () => viewOrderDetails(btn.getAttribute('data-id')));
        });
        
        document.querySelectorAll('.assign-btn').forEach(btn => {
            btn.addEventListener('click', () => openAssignmentModal(btn.getAttribute('data-id')));
        });
    }
    
    // View order details
    function viewOrderDetails(orderId) {
        const order = ordersData.find(o => o.id === orderId);
        if (!order) return;
        
        const orderDetailsContent = document.getElementById('order-details-content');
        const modal = document.getElementById('order-details-modal');
        
        // Get status class for styling
        const statusClass = (order.status && typeof order.status === 'string') ? 
            order.status.toLowerCase().replace(/\s+/g, '-') : 'unknown';
        
        // Build items list
        let itemsList = '<ul class="order-items-list">';
        if (Array.isArray(order.items)) {
            order.items.forEach(item => {
                const name = item?.name || 'Unknown Item';
                const price = item?.price || 0;
                itemsList += `
                    <li class="order-item">
                        <span>${name}</span>
                        <span>₱${typeof price === 'number' ? price.toFixed(2) : '0.00'}</span>
                    </li>`;
            });
        } else {
            itemsList += `<li class="order-item"><span>No items found</span></li>`;
        }
        itemsList += '</ul>';
        
        // Get assigned rider info
        let assignedTo = 'Not assigned';
        if (order.assignedTo && accountsData.rider) {
            const rider = accountsData.rider.find(r => r && r.username === order.assignedTo);
            assignedTo = rider ? rider.name : order.assignedTo;
        }
        
        // Build assignment info section
        let assignmentInfo = '';
        if (order.status === 'Assigned' || order.status === 'Delivered') {
            assignmentInfo = `
                <div class="order-section">
                    <h4>Assignment Information</h4>
                    <div class="assignment-info">
                        <p><strong>Assigned To:</strong> ${assignedTo}</p>
                        ${order.deliveredAt ? 
                            `<p><strong>Delivered At:</strong> ${new Date(order.deliveredAt).toLocaleString()}</p>` : ''}
                    </div>
                </div>
            `;
        }
        
        // Populate order details
        orderDetailsContent.innerHTML = `
            <div class="order-details-header">
                <h3>Order #${order.id}</h3>
                <span class="order-status ${statusClass}">${order.status || 'Unknown'}</span>
            </div>
            
            <div class="order-section">
                <h4>Customer Information</h4>
                <div class="customer-info">
                    <p><strong>Name:</strong> ${order.customer?.name || 'Unknown'}</p>
                    <p><strong>Phone:</strong> ${order.customer?.phone || 'Unknown'}</p>
                    <p><strong>Address:</strong> ${order.customer?.address || 'Unknown'}</p>
                    <p><strong>Order Date:</strong> ${order.date || 'Unknown'}</p>
                </div>
            </div>
            
            <div class="order-section">
                <h4>Order Items</h4>
                ${itemsList}
                
                <div class="order-summary">
                    <p>
                        <span>Subtotal:</span>
                        <span>₱${typeof order.subtotal === 'number' ? order.subtotal.toFixed(2) : 
                            (typeof order.total === 'number' ? order.total.toFixed(2) : '0.00')}</span>
                    </p>
                    ${order.deliveryFee ? 
                        `<p>
                            <span>Delivery Fee:</span>
                            <span>₱${order.deliveryFee.toFixed(2)}</span>
                        </p>` : ''}
                    ${order.shippingFee ? 
                        `<p>
                            <span>Shipping Fee:</span>
                            <span>₱${order.shippingFee.toFixed(2)}</span>
                        </p>` : ''}
                    <p class="order-total">
                        <span>Total:</span>
                        <span>₱${typeof order.total === 'number' ? order.total.toFixed(2) : '0.00'}</span>
                    </p>
                </div>
            </div>
            
            ${assignmentInfo}
            
            ${order.status === 'Processing' ? 
                `<div class="modal-actions">
                    <button class="assign-btn primary-btn" data-id="${order.id}">
                        <i class="fas fa-user-plus"></i> Assign Order
                    </button>
                </div>` : ''}
        `;
        
        // Add event listener to assign button if present
        const assignBtn = orderDetailsContent.querySelector('.assign-btn');
        if (assignBtn) {
            assignBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                openAssignmentModal(assignBtn.getAttribute('data-id'));
            });
        }
        
        // Show modal
        modal.style.display = 'block';
        
        // Close modal when clicking X
        modal.querySelector('.close-modal').onclick = () => {
            modal.style.display = 'none';
        };
        
        // Close modal when clicking outside
        window.onclick = (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
    }
    
    // Fetch riders from JSONBin
    async function fetchRiders() {
        try {
            logDebug('Fetching riders from JSONBin...', 'info');
            const ridersList = document.getElementById('riders-list');
            ridersList.innerHTML = '<tr><td colspan="6" class="no-data">Loading delivery personnel...</td></tr>';
            
            const response = await fetch(`https://api.jsonbin.io/v3/b/${ACCOUNTS_BIN}`, {
                method: 'GET',
                headers: {
                    'X-Access-Key': X_ACCESS_KEY
                }
            });
            
            if (!response.ok) {
                throw new Error(`Failed to fetch accounts: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            logDebug('Accounts data received:', 'success');
            
            if (!data || !data.record) {
                throw new Error('Invalid data format received from JSONBin');
            }
            
            accountsData = data.record || {};
            logDebug('Processed riders data', 'success');
            
            displayRiders();
            
            // Update driver select in assign tab if it's active
            if (document.getElementById('assign-tab').classList.contains('active')) {
                populateDriverSelect();
            }
        } catch (error) {
            logDebug(`Error fetching riders: ${error.message}`, 'error');
            const ridersList = document.getElementById('riders-list');
            ridersList.innerHTML = `<tr><td colspan="6" class="no-data">Error loading delivery personnel: ${error.message}</td></tr>`;
            alert('Failed to load delivery personnel. Please check the Debug tab for details.');
        }
    }
    
    // Display riders
    function displayRiders() {
        const ridersList = document.getElementById('riders-list');
        ridersList.innerHTML = '';
        
        if (!accountsData.rider || !Array.isArray(accountsData.rider) || accountsData.rider.length === 0) {
            ridersList.innerHTML = `<tr><td colspan="6" class="no-data">No delivery personnel found</td></tr>`;
            return;
        }
        
        accountsData.rider.forEach(rider => {
            // Check if rider object and its properties exist before using them
            if (!rider) return;
            
            const name = rider.name || 'Unknown';
            const username = rider.username || 'Unknown';
            const phone = rider.phone || 'Unknown';
            const status = rider.status || 'Unknown';
            const deliveries = rider.deliveries || 0;
            
            // Create a safe status class (lowercase and no spaces)
            const statusClass = (status && typeof status === 'string') ? 
                status.toLowerCase().replace(/\s+/g, '-') : 'unknown';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${name}</td>
                <td>${username}</td>
                <td>${phone}</td>
                <td><span class="status-badge ${statusClass}">${status}</span></td>
                <td>${deliveries}</td>
                <td>
                    <button class="view-assignments-btn" data-username="${username}">
                        <i class="fas fa-list"></i> View Orders
                    </button>
                </td>
            `;
            ridersList.appendChild(row);
        });
        
        // Add event listeners to view assignments buttons
        document.querySelectorAll('.view-assignments-btn').forEach(btn => {
            btn.addEventListener('click', () => viewRiderAssignments(btn.getAttribute('data-username')));
        });
    }
    
    // View rider assignments
    function viewRiderAssignments(username) {
        if (!username || !ordersData) return;
        
        const rider = accountsData.rider?.find(r => r && r.username === username);
        if (!rider) return;
        
        const assignedOrders = ordersData.filter(o => o && o.assignedTo === username && o.status !== 'Delivered');
        
        let ordersList = '';
        if (assignedOrders.length === 0) {
            ordersList = 'No active orders assigned to this driver.';
        } else {
            assignedOrders.forEach(order => {
                ordersList += `
                    <li>Order #${order.id}: ${order.customer?.name || 'Unknown'} - ${order.customer?.address || 'Unknown'}</li>
                `;
            });
        }
        
        alert(`
            Assigned Orders for ${rider.name}:
            
            ${ordersList ? `<ul>${ordersList}</ul>` : 'No active orders assigned.'}
        `);
    }
    
    // Open assignment modal
    function openAssignmentModal(orderId) {
        const modal = document.getElementById('assignment-modal');
        const order = ordersData.find(o => o.id === orderId);
        
        if (!order) return;
        
        // Populate order details
        const orderDetails = document.getElementById('modal-order-details');
        let itemsList = '';
        if (Array.isArray(order.items)) {
            order.items.forEach(item => {
                const name = item?.name || 'Unknown Item';
                const price = item?.price || 0;
                itemsList += `<li>${name} - ₱${typeof price === 'number' ? price.toFixed(2) : '0.00'}</li>`;
            });
        }
        
        orderDetails.innerHTML = `
            <p><strong>Order #${order.id}</strong></p>
            <p><strong>Customer:</strong> ${order.customer?.name || 'Unknown'} (${order.customer?.phone || 'Unknown'})</p>
            <p><strong>Address:</strong> ${order.customer?.address || 'Unknown'}</p>
            <p><strong>Items:</strong></p>
            <ul>${itemsList || 'No items found'}</ul>
            <p><strong>Total:</strong> ₱${typeof order.total === 'number' ? order.total.toFixed(2) : '0.00'}</p>
        `;
        
        // Populate rider selection
        const riderSelect = document.getElementById('rider-select');
        riderSelect.innerHTML = '<option value="">Select a driver</option>';
        
        if (accountsData.rider && Array.isArray(accountsData.rider) && accountsData.rider.length > 0) {
            // Filter active riders, handling potential undefined status
            const activeRiders = accountsData.rider.filter(r => r && r.status === 'Active');
            
            if (activeRiders.length === 0) {
                riderSelect.innerHTML += '<option value="" disabled>No active drivers available</option>';
            } else {
                activeRiders.forEach(rider => {
                    if (rider && rider.username && rider.name && rider.phone) {
                        riderSelect.innerHTML += `<option value="${rider.username}">${rider.name} (${rider.phone})</option>`;
                    }
                });
            }
        }
        
        // Set up assign button
        const assignBtn = document.getElementById('assign-btn');
        assignBtn.textContent = 'Assign Order';
        assignBtn.disabled = false;
        assignBtn.onclick = () => assignOrder(orderId);
        
        // Show modal
        modal.style.display = 'block';
        
        // Close modal when clicking X
        document.querySelector('.close-modal').onclick = () => {
            modal.style.display = 'none';
        };
        
        // Close modal when clicking outside
        window.onclick = (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
    }
    
    // Assign order to rider
    async function assignOrder(orderId) {
        const riderUsername = document.getElementById('rider-select').value;
        const assignBtn = document.getElementById('assign-btn');
        
        if (!riderUsername) {
            alert('Please select a delivery personnel');
            return;
        }
        
        try {
            // Show loading state
            assignBtn.disabled = true;
            assignBtn.innerHTML = `
                <div class="loading-indicator">
                    <span class="loading-spinner"></span>
                    <span>Assigning order...</span>
                </div>
            `;
            
            // Update order in ordersData
            const orderIndex = ordersData.findIndex(o => o.id === orderId);
            if (orderIndex === -1) throw new Error('Order not found');
            
            ordersData[orderIndex].status = 'Assigned';
            ordersData[orderIndex].assignedTo = riderUsername;
            
            // Update JSONBin
            const response = await fetch(`https://api.jsonbin.io/v3/b/${ORDERS_BIN}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Access-Key': X_ACCESS_KEY
                },
                body: JSON.stringify(ordersData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to update order');
            }
            
            // Close modal and refresh orders
            document.getElementById('assignment-modal').style.display = 'none';
            displayOrders(document.getElementById('status-filter').value);
            
            alert('Order assigned successfully!');
        } catch (error) {
            console.error('Error assigning order:', error);
            alert('Failed to assign order. Please try again.');
        } finally {
            // Reset button state
            assignBtn.disabled = false;
            assignBtn.textContent = 'Assign Order';
        }
    }
    
    // Add new rider
    document.getElementById('add-rider-btn').addEventListener('click', async () => {
        const name = document.getElementById('rider-name').value;
        const username = document.getElementById('rider-username').value;
        const password = document.getElementById('rider-password').value;
        const phone = document.getElementById('rider-phone').value;
        const messageElement = document.getElementById('add-rider-message');
        
        if (!name || !username || !password || !phone) {
            messageElement.textContent = 'Please fill in all fields';
            messageElement.className = 'message error';
            return;
        }
        
        try {
            // Check if username already exists
            if (accountsData.rider && Array.isArray(accountsData.rider) && 
                accountsData.rider.some(r => r && r.username === username)) {
                messageElement.textContent = 'Username already exists';
                messageElement.className = 'message error';
                return;
            }
            
            // Add new rider
            if (!accountsData.rider) {
                accountsData.rider = [];
            }
            
            accountsData.rider.push({
                username,
                password,
                name,
                phone,
                deliveries: 0,
                status: 'Active'
            });
            
            // Update JSONBin
            const response = await fetch(`https://api.jsonbin.io/v3/b/${ACCOUNTS_BIN}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Access-Key': X_ACCESS_KEY
                },
                body: JSON.stringify(accountsData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to add delivery personnel');
            }
            
            // Clear form and show success message
            document.getElementById('rider-name').value = '';
            document.getElementById('rider-username').value = '';
            document.getElementById('rider-password').value = '';
            document.getElementById('rider-phone').value = '';
            
            messageElement.textContent = 'Delivery personnel added successfully!';
            messageElement.className = 'message success';
            
            // Refresh riders list
            displayRiders();
            
            // Update driver select in assign tab
            populateDriverSelect();
        } catch (error) {
            console.error('Error adding rider:', error);
            messageElement.textContent = 'Failed to add delivery personnel. Please try again.';
            messageElement.className = 'message error';
        }
    });
    
    // Status filter change
    document.getElementById('status-filter').addEventListener('change', (e) => {
        displayOrders(e.target.value);
    });
    
    // Refresh buttons
    document.getElementById('refresh-orders').addEventListener('click', fetchOrders);
    document.getElementById('refresh-riders').addEventListener('click', fetchRiders);
    document.getElementById('refresh-assign').addEventListener('click', () => {
        fetchOrders();
        fetchRiders();
    });
    
    // Populate driver select dropdown
    function populateDriverSelect() {
        const driverSelect = document.getElementById('driver-select');
        driverSelect.innerHTML = '<option value="">Select a driver</option>';
        
        if (!accountsData.rider || !Array.isArray(accountsData.rider) || accountsData.rider.length === 0) {
            return;
        }
        
        // Filter active riders
        const activeRiders = accountsData.rider.filter(r => r && r.status === 'Active');
        
        activeRiders.forEach(rider => {
            if (rider && rider.username && rider.name) {
                driverSelect.innerHTML += `<option value="${rider.username}">${rider.name}</option>`;
            }
        });
    }
    
    // Handle driver select change
    function handleDriverSelect() {
        const driverUsername = document.getElementById('driver-select').value;
        const driverInfoElement = document.getElementById('driver-info');
        
        // Reset selected driver and orders
        selectedDriver = null;
        selectedOrders.clear();
        document.getElementById('assign-orders-btn').disabled = true;
        
        if (!driverUsername) {
            driverInfoElement.innerHTML = '<p>Select a driver to view their information</p>';
            return;
        }
        
        // Find the selected driver
        const driver = accountsData.rider?.find(r => r && r.username === driverUsername);
        if (!driver) {
            driverInfoElement.innerHTML = '<p>Driver information not found</p>';
            return;
        }
        
        // Set selected driver
        selectedDriver = driver;
        
        // Count active assignments
        const activeAssignments = ordersData.filter(o => 
            o && o.assignedTo === driverUsername && o.status === 'Assigned'
        ).length;
        
        // Display driver info
        driverInfoElement.innerHTML = `
            <div class="driver-info-header">
                <i class="fas fa-user-circle driver-avatar"></i>
                <h4>${driver.name || 'Unknown'}</h4>
            </div>
            <p><strong>Phone:</strong> ${driver.phone || 'Unknown'}</p>
            <p><strong>Status:</strong> <span class="status-badge ${driver.status?.toLowerCase() || 'unknown'}">${driver.status || 'Unknown'}</span></p>
            <p><strong>Total Deliveries:</strong> ${driver.deliveries || 0}</p>
            <p><strong>Active Assignments:</strong> ${activeAssignments}</p>
        `;
        
        // Update pending orders display
        displayPendingOrders();
        
        // Enable assign button if driver is selected
        updateAssignButtonState();
    }
    
    // Display pending orders
    function displayPendingOrders() {
        const pendingOrdersList = document.getElementById('pending-orders-list');
        pendingOrdersList.innerHTML = '';
        
        // Filter processing orders
        const pendingOrders = ordersData.filter(o => o && o.status === 'Processing');
        
        if (pendingOrders.length === 0) {
            pendingOrdersList.innerHTML = `<tr><td colspan="5" class="no-data">No pending orders found</td></tr>`;
            return;
        }
        
        pendingOrders.forEach(order => {
            if (!order) return;
            
            const id = order.id || 'Unknown';
            const customerName = order.customer?.name || 'Unknown';
            const customerPhone = order.customer?.phone || 'Unknown';
            const address = order.customer?.address || 'Unknown';
            const total = order.total || 0;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="order-checkbox" data-id="${id}">
                </td>
                <td>${id}</td>
                <td>${customerName}<br>${customerPhone}</td>
                <td>${address}</td>
                <td>₱${typeof total === 'number' ? total.toFixed(2) : '0.00'}</td>
            `;
            pendingOrdersList.appendChild(row);
        });
        
        // Add event listeners to checkboxes
        document.querySelectorAll('.order-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const orderId = this.getAttribute('data-id');
                
                if (this.checked) {
                    selectedOrders.add(orderId);
                } else {
                    selectedOrders.delete(orderId);
                }
                
                updateAssignButtonState();
            });
        });
    }
    
    // Filter pending orders based on search input
    function filterPendingOrders() {
        const searchTerm = document.getElementById('order-search').value.toLowerCase();
        const rows = document.querySelectorAll('#pending-orders-list tr');
        
        rows.forEach(row => {
            const orderId = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
            const customerInfo = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
            
            if (orderId.includes(searchTerm) || customerInfo.includes(searchTerm)) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    // Update assign button state
    function updateAssignButtonState() {
        const assignBtn = document.getElementById('assign-orders-btn');
        assignBtn.disabled = !selectedDriver || selectedOrders.size === 0;
    }
    
    // Assign selected orders to driver
    async function assignSelectedOrders() {
        if (!selectedDriver || selectedOrders.size === 0) {
            alert('Please select a driver and at least one order');
            return;
        }
        
        try {
            // Show loading state
            const assignBtn = document.getElementById('assign-orders-btn');
            const originalBtnContent = assignBtn.innerHTML;
            assignBtn.disabled = true;
            assignBtn.innerHTML = `
                <div class="loading-indicator">
                    <span class="loading-spinner"></span>
                    <span>Assigning orders...</span>
                </div>
            `;
            
            // Update orders in ordersData
            let updatedCount = 0;
            
            for (const orderId of selectedOrders) {
                const orderIndex = ordersData.findIndex(o => o && o.id === orderId);
                if (orderIndex !== -1) {
                    ordersData[orderIndex].status = 'Assigned';
                    ordersData[orderIndex].assignedTo = selectedDriver.username;
                    updatedCount++;
                }
            }
            
            if (updatedCount === 0) {
                throw new Error('No orders were updated');
            }
            
            // Update JSONBin
            const response = await fetch(`https://api.jsonbin.io/v3/b/${ORDERS_BIN}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Access-Key': X_ACCESS_KEY
                },
                body: JSON.stringify(ordersData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to update orders');
            }
            
            // Reset selected orders
            selectedOrders.clear();
            
            // Refresh displays
            displayPendingOrders();
            displayDriverAssignments();
            
            // Update assign button state
            updateAssignButtonState();
            
            alert(`${updatedCount} order(s) assigned successfully to ${selectedDriver.name}!`);
        } catch (error) {
            console.error('Error assigning orders:', error);
            alert('Failed to assign orders. Please try again.');
        } finally {
            // Reset button state
            const assignBtn = document.getElementById('assign-orders-btn');
            assignBtn.disabled = !selectedDriver;
            assignBtn.innerHTML = `<i class="fas fa-truck"></i> Assign Selected Orders`;
        }
    }
    
    // Display driver assignments
    function displayDriverAssignments() {
        const driverAssignmentsElement = document.getElementById('driver-assignments');
        driverAssignmentsElement.innerHTML = '';
        
        if (!accountsData.rider || !Array.isArray(accountsData.rider) || accountsData.rider.length === 0) {
            driverAssignmentsElement.innerHTML = '<p class="no-data">No drivers found</p>';
            return;
        }
        
        // Filter active riders
        const activeRiders = accountsData.rider.filter(r => r && r.status === 'Active');
        
        if (activeRiders.length === 0) {
            driverAssignmentsElement.innerHTML = '<p class="no-data">No active drivers found</p>';
            return;
        }
        
        // Create driver assignment cards
        activeRiders.forEach(rider => {
            if (!rider || !rider.username) return;
            
            // Get assigned orders for this driver
            const assignedOrders = ordersData.filter(o => 
                o && o.assignedTo === rider.username && o.status === 'Assigned'
            );
            
            const driverCard = document.createElement('div');
            driverCard.className = 'driver-assignment-card';
            
            let ordersList = '';
            if (assignedOrders.length === 0) {
                ordersList = '<p class="no-data">No active orders assigned</p>';
            } else {
                ordersList = '<ul class="assigned-orders-list">';
                assignedOrders.forEach(order => {
                    ordersList += `
                        <li>
                            <span class="order-id">Order #${order.id}</span>
                            <span class="order-customer">${order.customer?.name || 'Unknown'}</span>
                            <span class="order-address">${order.customer?.address || 'Unknown'}</span>
                        </li>
                    `;
                });
                ordersList += '</ul>';
            }
            
            driverCard.innerHTML = `
                <div class="driver-card-header">
                    <h4>${rider.name || 'Unknown'}</h4>
                    <span class="order-count">${assignedOrders.length} order(s)</span>
                </div>
                <div class="driver-card-content">
                    ${ordersList}
                </div>
            `;
            
            driverAssignmentsElement.appendChild(driverCard);
        });
    }
</script>
</body>
</html>